CREATE DATABASE HOSPITAL;
USE HOSPITAL;

CREATE TABLE PATIENT
(
	PATIENT_ID INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
	P_FNAME CHAR(20) NOT NULL,
	P_LNAME CHAR(20) ,
	P_GENDER ENUM('Male','Female' ,'Other') ,
	DOB DATE
);

CREATE TABLE SPECIALIZATION
(
	SP_ID INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
	SP_NAME CHAR(20)
);

CREATE TABLE WARD
(
	WARD_NUM INT NOT NULL PRIMARY KEY,
	NUM_BEDS INT,
	EMPTY_BEDS INT
);

CREATE TABLE WARD_INFO
(
	WARD_NUM INT NOT NULL,
	PATIENT_ID INT NOT NULL,
	S_DATE DATE,
	E_DATE DATE,
	CONSTRAINT FK_W_INFO_W_NUM FOREIGN KEY(WARD_NUM) REFERENCES WARD(WARD_NUM),
	CONSTRAINT FK_W_INFO_P_ID FOREIGN KEY(PATIENT_ID) REFERENCES PATIENT(PATIENT_ID),
	CONSTRAINT PK_WARD_NUM PRIMARY KEY (WARD_NUM , PATIENT_ID , S_DATE)
);

CREATE TABLE EMPLOYEETYPE
(
	EMP_TYPE_ID INT NOT NULL PRIMARY KEY AUTO_INCREMENT ,
	EMP_TYPE_NAME ENUM('Pharmacist' , 'Doctor' , 'Receptionist')
);

CREATE TABLE MEDICINE
(
	MED_ID INT NOT NULL PRIMARY KEY,
	MED_NAME CHAR(20) NOT NULL,
	MED_PRICE INT NOT NULL,
	MED_DOSE CHAR(10),
	MED_DESC CHAR(30),
	NUM_MEDS INT
);

CREATE TABLE EMPLOYEE
(
	EMP_ID INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
	EMP_FNAME CHAR(20) NOT NULL,
	EMP_LNAME CHAR(20),
	EMP_JOIN_DATE DATE  NOT NULL,
	EMP_GENDER ENUM('Male','Female','Other'),
	EMP_SALARY INT,
	EMP_PHONE CHAR(20),
	EMP_TYPE_ID INT NOT NULL,
	EMP_PASSWORD CHAR(50),
	CONSTRAINT FK_EMP_TYPE_ID FOREIGN KEY(EMP_TYPE_ID) REFERENCES EMPLOYEETYPE(EMP_TYPE_ID)
);

CREATE TABLE DOCTOR
(
	EMP_ID INT NOT NULL,
	SP_ID INT NOT NULL,
	DOC_OFFICE INT,
	CONSTRAINT FK_DOC_TYPE_ID FOREIGN KEY (EMP_ID) REFERENCES EMPLOYEE(EMP_ID),
	CONSTRAINT FK_DOC_SP_ID FOREIGN KEY (SP_ID) REFERENCES SPECIALIZATION(SP_ID),
	CONSTRAINT PK_DOCTOR PRIMARY KEY (EMP_ID , SP_ID)
);

CREATE TABLE NURSE
(
	EMP_ID INT NOT NULL,
	WARD_NUM INT NOT NULL,
	CONSTRAINT FK_NURSE_EMP_ID FOREIGN KEY(EMP_ID) REFERENCES EMPLOYEE(EMP_ID),
	CONSTRAINT FK_NURSE_WARD_NUM FOREIGN KEY(WARD_NUM) REFERENCES WARD(WARD_NUM),
	CONSTRAINT PK_NURSE PRIMARY KEY(EMP_ID , WARD_NUM)
);

CREATE TABLE APPOINTMENT
(
	APP_ID INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
	PATIENT_ID INT NOT NULL,
	EMP_ID INT NOT NULL ,
	MED_ID INT ,
	WARD_NUM INT ,
	APP_DATE DATE ,
	APP_TIME TIME ,
	FLAG_DONE TINYINT(1) DEFAULT 0,
	CONSTRAINT FK_APP_PID FOREIGN KEY(PATIENT_ID) REFERENCES PATIENT(PATIENT_ID),
	CONSTRAINT FK_APP_EMP_ID FOREIGN KEY(EMP_ID) REFERENCES EMPLOYEE(EMP_ID),
	CONSTRAINT FK_APP_MED_ID FOREIGN KEY(MED_ID) REFERENCES MEDICINE(MED_ID),
	CONSTRAINT FK_APP_WARD_NUM FOREIGN KEY (WARD_NUM) REFERENCES WARD(WARD_NUM)
);

CREATE TABLE LOGIN
(
LOGIN_ID INT NOT NULL PRIMARY KEY AUTO_INCREMENT,	
EMP_ID INT ,
USERNAME VARCHAR(30) NOT NULL ,
PASSWORD VARCHAR(50) NOT NULL ,
ROLE ENUM('Pharmacist' , 'Doctor' , 'Receptionist') ,
CONSTRAINT FK_LOG_EMP_ID FOREIGN KEY(EMP_ID) REFERENCES EMPLOYEE(EMP_ID)
);

CREATE TABLE BILL
(
	BILL_ID INT NOT NULL PRIMARY KEY,
	APP_ID INT NOT NULL,
	GRAND_TOTAL INT,
	PAID TINYINT(1),
	CONSTRAINT FK_BILL_APPID FOREIGN KEY(APP_ID) REFERENCES APPOINTMENT(APP_ID)
);

CREATE TABLE MEDICINES
(
	BILL_ID INT NOT NULL,
	MED_ID INT NOT NULL,
	QUANTITY INT,
	TOTAL_PRICE INT,
	CONSTRAINT FK_MED_BILLID FOREIGN KEY(BILL_ID) REFERENCES BILL(BILL_ID),
	CONSTRAINT FK_MED_MEDID FOREIGN KEY(MED_ID) REFERENCES MEDICINE(MED_ID),
	CONSTRAINT PK_MEDS PRIMARY KEY(BILL_ID,MED_ID)
);



INSERT INTO PATIENT(PATIENT_ID,P_FNAME,P_LNAME,P_GENDER,DOB) VALUES(1, 'Ahmed', 'Khan', 'MALE', '1990-03-12');
INSERT INTO PATIENT(PATIENT_ID,P_FNAME,P_LNAME,P_GENDER,DOB) VALUES(2, 'Farhan', 'Abbasi', 'MALE', '2000-12-11');
INSERT INTO PATIENT(PATIENT_ID,P_FNAME,P_LNAME,P_GENDER,DOB) VALUES(4, 'sadiq', 'Khan', 'MALE', '2002-02-12');

INSERT INTO SPECIALIZATION VALUES(1,"DENTIST");
INSERT INTO SPECIALIZATION VALUES(2,"SURGEON");
INSERT INTO SPECIALIZATION VALUES(3,"INTERNIST");
INSERT into SPECIALIZATION VALUES(4,"ENT");

INSERT INTO WARD VALUES(1,6,6);
INSERT INTO WARD VALUES(2,6,6);
INSERT INTO WARD VALUES(3,6,6);
INSERT INTO WARD VALUES(4,6,6);

INSERT INTO EMPLOYEETYPE(EMP_TYPE_ID, EMP_TYPE_NAME) VALUES(1, 'Receptionist');
INSERT INTO EMPLOYEETYPE(EMP_TYPE_ID, EMP_TYPE_NAME) VALUES(2, 'Doctor');
INSERT INTO EMPLOYEETYPE(EMP_TYPE_ID, EMP_TYPE_NAME) VALUES(3, 'Pharmacist');

INSERT INTO MEDICINE VALUES(1,"Panadol",120,"200mg","Pain-Killer",100);
INSERT INTO MEDICINE VALUES(2,"Despirn",100,"120mg","Pain-Killer",100);
INSERT INTO MEDICINE VALUES(3,"FLAGYL",50,"120mg","Anti-Biotics",100);

INSERT INTO EMPLOYEE(EMP_ID, EMP_FNAME, EMP_LNAME, EMP_JOIN_DATE, EMP_GENDER, EMP_SALARY, EMP_PHONE, EMP_TYPE_ID, EMP_PASSWORD) VALUES(1, 'farhan', 'abbasi', '2021-01-02', 'MALE', 450000, '03044434334', 1, '81dc9bdb52d04dc20036dbd8313ed055');
INSERT INTO EMPLOYEE(EMP_ID, EMP_FNAME, EMP_LNAME, EMP_JOIN_DATE, EMP_GENDER, EMP_SALARY, EMP_PHONE, EMP_TYPE_ID, EMP_PASSWORD) VALUES(2, 'jawad', 'ahmed', '2021-02-03', 'MALE', 450000, '0302323223', 2, '81dc9bdb52d04dc20036dbd8313ed055');
INSERT INTO EMPLOYEE(EMP_ID, EMP_FNAME, EMP_LNAME, EMP_JOIN_DATE, EMP_GENDER, EMP_SALARY, EMP_PHONE, EMP_TYPE_ID, EMP_PASSWORD) VALUES(3, 'hina', 'khan', '2022-02-02', 'FEMALE', 30000, '0303003030', 3, '81dc9bdb52d04dc20036dbd8313ed055');

INSERT INTO DOCTOR(EMP_ID, SP_ID, DOC_OFFICE) VALUES(1, 1, 12);
INSERT INTO DOCTOR(EMP_ID, SP_ID, DOC_OFFICE) VALUES(2, 2, 13);


INSERT INTO APPOINTMENT(APP_ID, PATIENT_ID, EMP_ID, MED_ID , WARD_NUM , APP_DATE, APP_TIME) VALUES(2, 2, 2, NULL, 1, '2022-02-21', '10:12:00');

INSERT INTO LOGIN (LOGIN_ID, EMP_ID, USERNAME, PASSWORD, ROLE) VALUES(1, 1, 'farhan', '81dc9bdb52d04dc20036dbd8313ed055', 'Doctor');
INSERT INTO LOGIN (LOGIN_ID, EMP_ID, USERNAME, PASSWORD, ROLE) VALUES(2, 3, 'hina', '81dc9bdb52d04dc20036dbd8313ed055', 'Receptionist');
INSERT INTO LOGIN (LOGIN_ID, EMP_ID, USERNAME, PASSWORD, ROLE) VALUES(3, 2, 'jawad', '81dc9bdb52d04dc20036dbd8313ed055', 'Pharmacist');

DELIMITER $$
CREATE PROCEDURE ASSIGN_BED(IN PAT_ID INT , OUT W_NUM INT)
BEGIN
DECLARE EMPTY_NUM INT;
SELECT MIN(WARD_NUM) INTO W_NUM FROM WARD WHERE EMPTY_BEDS > 0;
SELECT EMPTY_BEDS INTO EMPTY_NUM FROM WARD WHERE WARD_NUM = W_NUM;
UPDATE WARD SET EMPTY_BEDS = EMPTY_NUM-1 WHERE WARD_NUM = W_NUM;
INSERT INTO WARD_INFO VALUES (W_NUM,PAT_ID,CURDATE(),NULL);
END $$
DELIMITER ;




